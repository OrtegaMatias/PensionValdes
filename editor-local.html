<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor Dashboard - Pensi√≥n Vald√©s</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/responsive.css">
  <style>
    .editor-container {
      max-width: 900px;
      margin: 0 auto;
      padding: var(--spacing-lg);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-family: var(--font-sans);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--error);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .section-divider {
      margin: var(--spacing-2xl) 0;
      border: none;
      border-top: 2px solid var(--border);
    }

    .current-status-box {
      background: var(--bg-secondary);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: var(--spacing-sm);
    }

    .status-active {
      background: var(--success);
    }

    .status-inactive {
      background: var(--idle);
    }

    .download-section {
      background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
      color: white;
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      text-align: center;
      margin-top: var(--spacing-2xl);
    }

    .download-section h2 {
      margin-bottom: var(--spacing-md);
    }

    .download-section p {
      margin-bottom: var(--spacing-lg);
      opacity: 0.9;
    }

    .code-block {
      background: rgba(0, 0, 0, 0.2);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-family: var(--font-mono);
      font-size: 0.875rem;
      text-align: left;
      margin: var(--spacing-md) 0;
    }

    .hidden {
      display: none;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--spacing-md);
    }

    .history-table th {
      text-align: left;
      padding: var(--spacing-sm);
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
      font-size: 0.875rem;
    }

    .history-table td {
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--border);
    }

    .history-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .btn-small {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.75rem;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      margin-right: var(--spacing-xs);
    }

    .btn-edit {
      background: var(--primary);
      color: white;
    }

    .btn-delete {
      background: var(--error);
      color: white;
    }

    .btn-small:hover {
      opacity: 0.8;
    }

    .edit-row {
      background: #fef3c7 !important;
    }

    .edit-row input,
    .edit-row select,
    .edit-row textarea {
      padding: var(--spacing-xs);
      font-size: 0.875rem;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }

    .edit-row textarea {
      min-height: 40px;
    }

    .no-history {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <header class="header">
      <div class="header-content">
        <h1>Editor de Datos</h1>
        <p class="subtitle">Actualiza el estado de tus impresiones</p>
      </div>
      <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">
        Ver Dashboard
      </a>
    </header>

    <!-- Estado Actual -->
    <section class="card">
      <h2 class="section-title">Estado Actual</h2>
      <div class="current-status-box" id="current-status-display">
        <!-- Actualizado din√°micamente -->
      </div>

      <form id="form-current-print">
        <div class="form-group">
          <label>
            <input type="checkbox" id="is-active">
            Hay una impresi√≥n en curso
          </label>
        </div>

        <div id="print-details" class="hidden">
          <div class="form-row">
            <div class="form-group">
              <label for="item-type">Tipo de √≠tem</label>
              <select id="item-type">
                <option value="">Seleccionar...</option>
                <option value="pocillos">Pocillos</option>
                <option value="charolas">Charolas</option>
              </select>
            </div>

            <div class="form-group">
              <label for="batch-size">Tama√±o del lote</label>
              <input type="number" id="batch-size" min="1" placeholder="4">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="start-time">Fecha y hora de inicio</label>
              <input type="datetime-local" id="start-time">
            </div>

            <div class="form-group">
              <label for="estimated-duration">Duraci√≥n estimada (minutos)</label>
              <input type="number" id="estimated-duration" min="1" placeholder="180">
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary">Actualizar Estado Actual</button>
      </form>
    </section>

    <hr class="section-divider">

    <!-- Completar Impresi√≥n -->
    <section class="card">
      <h2 class="section-title">Completar Impresi√≥n</h2>
      <p class="text-muted" style="margin-bottom: var(--spacing-lg);">
        Registra una impresi√≥n que termin√≥ exitosamente
      </p>

      <form id="form-complete-print">
        <div class="form-row">
          <div class="form-group">
            <label for="complete-item">Tipo de √≠tem</label>
            <select id="complete-item" required>
              <option value="">Seleccionar...</option>
              <option value="pocillos">Pocillos</option>
              <option value="charolas">Charolas</option>
            </select>
          </div>

          <div class="form-group">
            <label for="complete-batch">Tama√±o del lote</label>
            <input type="number" id="complete-batch" min="1" required placeholder="4">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="complete-date">Fecha</label>
            <input type="date" id="complete-date" required>
          </div>

          <div class="form-group">
            <label for="complete-duration">Duraci√≥n real (minutos)</label>
            <input type="number" id="complete-duration" min="1" required placeholder="185">
          </div>
        </div>

        <div class="form-group">
          <label for="complete-notes">Notas (opcional)</label>
          <textarea id="complete-notes" placeholder="Ej: Primera impresi√≥n exitosa"></textarea>
        </div>

        <button type="submit" class="btn-primary btn-success">Agregar Impresi√≥n Completada</button>
      </form>
    </section>

    <hr class="section-divider">

    <!-- Registrar Fallo -->
    <section class="card">
      <h2 class="section-title">Registrar Fallo</h2>
      <p class="text-muted" style="margin-bottom: var(--spacing-lg);">
        Registra una impresi√≥n que fall√≥ y documenta el problema
      </p>

      <form id="form-failed-print">
        <div class="form-row">
          <div class="form-group">
            <label for="failed-item">Tipo de √≠tem</label>
            <select id="failed-item" required>
              <option value="">Seleccionar...</option>
              <option value="pocillos">Pocillos</option>
              <option value="charolas">Charolas</option>
            </select>
          </div>

          <div class="form-group">
            <label for="failed-batch">Tama√±o del lote</label>
            <input type="number" id="failed-batch" min="1" required placeholder="1">
          </div>
        </div>

        <div class="form-group">
          <label for="failed-date">Fecha</label>
          <input type="date" id="failed-date" required>
        </div>

        <div class="form-group">
          <label for="issue-type">Tipo de problema</label>
          <select id="issue-type" required>
            <option value="">Seleccionar...</option>
            <option value="material">Material (filamento)</option>
            <option value="hardware">Hardware (mec√°nico)</option>
            <option value="software">Software (configuraci√≥n)</option>
            <option value="adhesion">Adhesi√≥n (a la cama)</option>
            <option value="quality">Calidad de impresi√≥n</option>
          </select>
        </div>

        <div class="form-group">
          <label for="issue-description">Descripci√≥n del problema</label>
          <textarea id="issue-description" required placeholder="¬øQu√© sali√≥ mal?"></textarea>
        </div>

        <div class="form-group">
          <label for="issue-resolution">Resoluci√≥n (opcional)</label>
          <textarea id="issue-resolution" placeholder="¬øC√≥mo lo resolviste?"></textarea>
        </div>

        <button type="submit" class="btn-primary btn-danger">Registrar Fallo</button>
      </form>
    </section>

    <hr class="section-divider">

    <!-- Gestionar Historial -->
    <section class="card">
      <h2 class="section-title">Gestionar Historial</h2>
      <p class="text-muted" style="margin-bottom: var(--spacing-lg);">
        Edita o elimina impresiones del historial
      </p>

      <div id="history-management">
        <!-- Renderizado din√°micamente -->
      </div>
    </section>

    <!-- Guardar y Publicar -->
    <section class="download-section">
      <h2>3. Guardar y Publicar</h2>
      <p>Una vez que hayas hecho tus cambios, guarda y publica directamente a GitHub</p>
      <button onclick="saveAndPush()" id="btn-save" class="btn-primary" style="background: white; color: var(--primary); max-width: 400px; margin: 0 auto;">
        üíæ Guardar y Subir a GitHub
      </button>
      <div id="save-status" style="margin-top: var(--spacing-lg); font-size: 0.875rem;"></div>
    </section>
  </div>

  <script src="js/dataLoader.js"></script>
  <script>
    let currentData = null;

    // Cargar datos al iniciar
    async function loadData() {
      try {
        currentData = await DataLoader.load('data/print-data.json');
        updateCurrentStatusDisplay();
      } catch (error) {
        console.error('Error cargando datos:', error);
        alert('Error al cargar datos. Usando datos vac√≠os.');
        currentData = {
          meta: {
            projectName: "Proyecto Pensi√≥n Vald√©s",
            goals: { pocillos: 100, charolas: 20 },
            startDate: new Date().toISOString().split('T')[0]
          },
          currentPrint: {
            isActive: false,
            item: "",
            batchSize: 0,
            startTime: "",
            estimatedDuration: 0
          },
          history: [],
          issues: []
        };
      }
    }

    // Actualizar display del estado actual
    function updateCurrentStatusDisplay() {
      const display = document.getElementById('current-status-display');
      const isActive = currentData.currentPrint.isActive;

      if (isActive) {
        display.innerHTML = `
          <span class="status-indicator status-active"></span>
          <strong>FUNCIONANDO</strong> - Imprimiendo ${currentData.currentPrint.batchSize}
          ${currentData.currentPrint.item} (estimado: ${currentData.currentPrint.estimatedDuration} min)
        `;
      } else {
        display.innerHTML = `
          <span class="status-indicator status-inactive"></span>
          <strong>EN REPOSO</strong> - No hay impresi√≥n activa
        `;
      }
    }

    // Toggle detalles de impresi√≥n
    document.getElementById('is-active').addEventListener('change', (e) => {
      const details = document.getElementById('print-details');
      details.classList.toggle('hidden', !e.target.checked);
    });

    // Form: Actualizar estado actual
    document.getElementById('form-current-print').addEventListener('submit', (e) => {
      e.preventDefault();

      const isActive = document.getElementById('is-active').checked;

      if (isActive) {
        const itemType = document.getElementById('item-type').value;
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const startTime = document.getElementById('start-time').value;
        const estimatedDuration = parseInt(document.getElementById('estimated-duration').value);

        if (!itemType || !batchSize || !startTime || !estimatedDuration) {
          alert('Por favor completa todos los campos');
          return;
        }

        currentData.currentPrint = {
          isActive: true,
          item: itemType,
          batchSize: batchSize,
          startTime: startTime,
          estimatedDuration: estimatedDuration
        };
      } else {
        currentData.currentPrint = {
          isActive: false,
          item: "",
          batchSize: 0,
          startTime: "",
          estimatedDuration: 0
        };
      }

      updateCurrentStatusDisplay();
      alert('Estado actual actualizado. Click en "Guardar y Subir a GitHub" para publicar.');
    });

    // Form: Completar impresi√≥n
    document.getElementById('form-complete-print').addEventListener('submit', (e) => {
      e.preventDefault();

      const newId = currentData.history.length > 0
        ? Math.max(...currentData.history.map(h => h.id)) + 1
        : 1;

      const newEntry = {
        id: newId,
        date: document.getElementById('complete-date').value,
        item: document.getElementById('complete-item').value,
        batchSize: parseInt(document.getElementById('complete-batch').value),
        duration: parseInt(document.getElementById('complete-duration').value),
        status: "completed",
        notes: document.getElementById('complete-notes').value || ""
      };

      currentData.history.push(newEntry);

      // Desactivar currentPrint si estaba activo
      currentData.currentPrint = {
        isActive: false,
        item: "",
        batchSize: 0,
        startTime: "",
        estimatedDuration: 0
      };

      updateCurrentStatusDisplay();
      renderHistoryTable();
      e.target.reset();
      alert(`Impresi√≥n #${newId} agregada exitosamente. Click en "Guardar y Subir a GitHub" para publicar.`);
    });

    // Form: Registrar fallo
    document.getElementById('form-failed-print').addEventListener('submit', (e) => {
      e.preventDefault();

      const newHistoryId = currentData.history.length > 0
        ? Math.max(...currentData.history.map(h => h.id)) + 1
        : 1;

      const newIssueId = currentData.issues.length > 0
        ? Math.max(...currentData.issues.map(i => i.id)) + 1
        : 1;

      const date = document.getElementById('failed-date').value;

      // Agregar al historial
      const historyEntry = {
        id: newHistoryId,
        date: date,
        item: document.getElementById('failed-item').value,
        batchSize: parseInt(document.getElementById('failed-batch').value),
        duration: 0,
        status: "failed",
        notes: document.getElementById('issue-description').value
      };

      currentData.history.push(historyEntry);

      // Agregar a issues
      const issueEntry = {
        id: newIssueId,
        date: date,
        type: document.getElementById('issue-type').value,
        description: document.getElementById('issue-description').value,
        resolution: document.getElementById('issue-resolution').value || "",
        printId: newHistoryId
      };

      currentData.issues.push(issueEntry);

      // Desactivar currentPrint
      currentData.currentPrint = {
        isActive: false,
        item: "",
        batchSize: 0,
        startTime: "",
        estimatedDuration: 0
      };

      updateCurrentStatusDisplay();
      renderHistoryTable();
      e.target.reset();
      alert(`Fallo #${newHistoryId} registrado. Click en "Guardar y Subir a GitHub" para publicar.`);
    });

    // Guardar y hacer push a GitHub
    async function saveAndPush() {
      const btn = document.getElementById('btn-save');
      const status = document.getElementById('save-status');

      btn.disabled = true;
      btn.textContent = '‚è≥ Guardando...';
      status.textContent = '';

      try {
        // 1. Guardar archivo
        const saveResponse = await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentData)
        });

        const saveData = await saveResponse.json();

        if (!saveData.success) {
          throw new Error(saveData.error || 'Error al guardar');
        }

        status.innerHTML = '‚úÖ Archivo guardado<br>';
        btn.textContent = 'üì§ Subiendo a GitHub...';

        // 2. Git push
        const pushResponse = await fetch('/api/git-push', {
          method: 'POST'
        });

        const pushData = await pushResponse.json();

        if (!pushData.success) {
          throw new Error(pushData.error || 'Error en git push');
        }

        status.innerHTML += '‚úÖ Cambios subidos a GitHub<br><br>üéâ ¬°Dashboard actualizado! Visita:<br><a href="https://ortegamatias.github.io/PensionValdes/" target="_blank" style="color: white; text-decoration: underline;">https://ortegamatias.github.io/PensionValdes/</a>';
        btn.textContent = '‚úÖ Completado';

        setTimeout(() => {
          btn.textContent = 'üíæ Guardar y Subir a GitHub';
          btn.disabled = false;
        }, 3000);

      } catch (error) {
        console.error('Error:', error);
        status.innerHTML = `‚ùå Error: ${error.message}`;
        btn.textContent = '‚ùå Error - Reintentar';
        btn.disabled = false;
      }
    }

    // Renderizar tabla de historial
    function renderHistoryTable() {
      const container = document.getElementById('history-management');
      if (!container) return;

      if (!currentData.history || currentData.history.length === 0) {
        container.innerHTML = '<div class="no-history">No hay impresiones en el historial</div>';
        return;
      }

      // Ordenar por ID (m√°s reciente primero)
      const sorted = [...currentData.history].sort((a, b) => b.id - a.id);

      const rows = sorted.map(h => {
        const statusBadge = h.status === 'completed'
          ? '<span style="color: var(--success);">‚úì Completada</span>'
          : '<span style="color: var(--error);">‚úó Fallida</span>';

        return `
          <tr id="row-${h.id}">
            <td>#${h.id}</td>
            <td>${h.date}</td>
            <td>${h.item === 'pocillos' ? 'Pocillos' : 'Charolas'}</td>
            <td>${h.batchSize}</td>
            <td>${h.duration} min</td>
            <td>${statusBadge}</td>
            <td>${h.notes || '--'}</td>
            <td>
              <button class="btn-small btn-edit" onclick="editHistoryItem(${h.id})">‚úèÔ∏è Editar</button>
              <button class="btn-small btn-delete" onclick="deleteHistoryItem(${h.id})">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="history-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>√çtem</th>
              <th>Lote</th>
              <th>Duraci√≥n</th>
              <th>Estado</th>
              <th>Notas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // Editar entrada del historial
    let editingId = null;

    function editHistoryItem(id) {
      // Si ya estamos editando otro, cancelar
      if (editingId !== null) {
        cancelEdit();
      }

      const item = currentData.history.find(h => h.id === id);
      if (!item) return;

      editingId = id;
      const row = document.getElementById(`row-${id}`);

      row.classList.add('edit-row');
      row.innerHTML = `
        <td>#${id}</td>
        <td><input type="date" id="edit-date-${id}" value="${item.date}"></td>
        <td>
          <select id="edit-item-${id}">
            <option value="pocillos" ${item.item === 'pocillos' ? 'selected' : ''}>Pocillos</option>
            <option value="charolas" ${item.item === 'charolas' ? 'selected' : ''}>Charolas</option>
          </select>
        </td>
        <td><input type="number" id="edit-batch-${id}" value="${item.batchSize}" min="1"></td>
        <td><input type="number" id="edit-duration-${id}" value="${item.duration}" min="0"></td>
        <td>
          <select id="edit-status-${id}">
            <option value="completed" ${item.status === 'completed' ? 'selected' : ''}>Completada</option>
            <option value="failed" ${item.status === 'failed' ? 'selected' : ''}>Fallida</option>
          </select>
        </td>
        <td><textarea id="edit-notes-${id}">${item.notes || ''}</textarea></td>
        <td>
          <button class="btn-small" style="background: var(--success); color: white;" onclick="saveHistoryEdit(${id})">üíæ Guardar</button>
          <button class="btn-small" style="background: var(--idle); color: white;" onclick="cancelEdit()">‚úñ Cancelar</button>
        </td>
      `;
    }

    // Guardar edici√≥n
    function saveHistoryEdit(id) {
      const itemIndex = currentData.history.findIndex(h => h.id === id);
      if (itemIndex === -1) return;

      currentData.history[itemIndex] = {
        id: id,
        date: document.getElementById(`edit-date-${id}`).value,
        item: document.getElementById(`edit-item-${id}`).value,
        batchSize: parseInt(document.getElementById(`edit-batch-${id}`).value),
        duration: parseInt(document.getElementById(`edit-duration-${id}`).value),
        status: document.getElementById(`edit-status-${id}`).value,
        notes: document.getElementById(`edit-notes-${id}`).value
      };

      editingId = null;
      renderHistoryTable();
      alert('Cambios guardados. No olvides hacer click en "Guardar y Subir a GitHub".');
    }

    // Cancelar edici√≥n
    function cancelEdit() {
      editingId = null;
      renderHistoryTable();
    }

    // Eliminar entrada del historial
    function deleteHistoryItem(id) {
      if (!confirm(`¬øSeguro que quieres eliminar la impresi√≥n #${id}?`)) {
        return;
      }

      currentData.history = currentData.history.filter(h => h.id !== id);

      // Tambi√©n eliminar issues relacionados
      currentData.issues = currentData.issues.filter(i => i.printId !== id);

      renderHistoryTable();
      alert('Entrada eliminada. No olvides hacer click en "Guardar y Subir a GitHub".');
    }

    // Inicializar
    async function init() {
      await loadData();
      renderHistoryTable();
    }

    init();

    // Establecer fecha de hoy por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('complete-date').value = today;
    document.getElementById('failed-date').value = today;

    // Establecer datetime actual
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('start-time').value = now.toISOString().slice(0, 16);
  </script>
</body>
</html>
