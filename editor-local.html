<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor Dashboard - Pensi√≥n Vald√©s</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/responsive.css">
  <style>
    .editor-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }

    .editor-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1.15fr);
      gap: var(--spacing-2xl);
      align-items: start;
    }

    .editor-column {
      display: grid;
      gap: var(--spacing-xl);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .editor-column section {
      margin-bottom: 0;
    }

    .section-header .section-title {
      margin-bottom: 0;
    }

    .step-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 700;
      font-size: 0.875rem;
    }

    .helper-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-family: var(--font-sans);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--error);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .section-divider {
      margin: var(--spacing-2xl) 0;
      border: none;
      border-top: 2px solid var(--border);
    }

    .table-scroll {
      overflow-x: auto;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
    }

    .current-status-box {
      background: var(--bg-secondary);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: var(--spacing-sm);
    }

    .status-active {
      background: var(--success);
    }

    .status-inactive {
      background: var(--idle);
    }

    .save-panel {
      position: sticky;
      top: var(--spacing-lg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      background: var(--bg-primary);
      box-shadow: var(--shadow-sm);
    }

    .save-panel h2 {
      margin-bottom: var(--spacing-sm);
    }

    .save-panel p {
      margin-bottom: var(--spacing-lg);
      color: var(--text-secondary);
    }

    .save-status a {
      color: var(--primary);
      text-decoration: underline;
    }

    .save-status {
      margin-top: var(--spacing-lg);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .code-block {
      background: rgba(0, 0, 0, 0.2);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      font-family: var(--font-mono);
      font-size: 0.875rem;
      text-align: left;
      margin: var(--spacing-md) 0;
    }

    .hidden {
      display: none;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--spacing-md);
    }

    .table-scroll .history-table {
      margin-top: 0;
      min-width: 720px;
    }

    .history-table th {
      text-align: left;
      padding: var(--spacing-sm);
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
      font-size: 0.875rem;
    }

    .history-table td {
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--border);
    }

    .history-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .btn-small {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.75rem;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      margin-right: var(--spacing-xs);
    }

    .btn-edit {
      background: var(--primary);
      color: white;
    }

    .btn-delete {
      background: var(--error);
      color: white;
    }

    .btn-small:hover {
      opacity: 0.8;
    }

    .status-pending {
      color: var(--warning);
      font-weight: 600;
    }

    .status-completed {
      color: var(--success);
      font-weight: 600;
    }

    .status-partial {
      color: #f59e0b;
      font-weight: 600;
    }

    .status-failed {
      color: var(--error);
      font-weight: 600;
    }

    .row-pending {
      background: #fef3c7;
    }

    .history-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .legend-dot.status-completed {
      background: var(--success);
    }

    .legend-dot.status-partial {
      background: #f59e0b;
    }

    .legend-dot.status-failed {
      background: var(--error);
    }

    .legend-dot.status-pending {
      background: var(--warning);
    }

    .rating-panel {
      margin-top: var(--spacing-lg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      background: var(--bg-primary);
      box-shadow: var(--shadow-sm);
    }

    .rating-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .panel-section {
      border-top: 1px solid var(--border);
      padding-top: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .panel-title {
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .rating-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: var(--spacing-md);
    }

    @media (max-width: 960px) {
      .editor-layout {
        grid-template-columns: 1fr;
      }

      .save-panel {
        position: static;
      }

      .rating-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .no-history {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <header class="header">
      <div class="header-content">
        <h1>Editor de Datos</h1>
        <p class="subtitle">Actualiza el estado de tus impresiones</p>
      </div>
      <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-block;">
        Ver Dashboard
      </a>
    </header>

    <div class="editor-layout">
      <div class="editor-column">
        <!-- Configuraci√≥n del Proyecto -->
        <section class="card">
          <div class="section-header">
            <span class="step-pill">1</span>
            <h2 class="section-title">Configuraci√≥n del Proyecto</h2>
          </div>
          <form id="form-project-config">
            <div class="form-row">
              <div class="form-group">
                <label for="project-name">Nombre del proyecto</label>
                <input type="text" id="project-name" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="start-date-project">Fecha de inicio real</label>
                <input type="date" id="start-date-project" required>
              </div>

              <div class="form-group">
                <label for="target-end-date">Fecha de t√©rmino pactada</label>
                <input type="date" id="target-end-date" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="goal-pocillos">Meta de pocillos</label>
                <input type="number" id="goal-pocillos" min="1" required>
              </div>

              <div class="form-group">
                <label for="goal-charolas">Meta de charolas</label>
                <input type="number" id="goal-charolas" min="1" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="work-hours">Horas de trabajo por d√≠a</label>
                <input type="number" id="work-hours" min="1" max="24" required placeholder="18">
              </div>
            </div>

            <button type="submit" class="btn-primary">Actualizar Configuraci√≥n</button>
          </form>
        </section>

        <!-- Estado Actual -->
        <section class="card">
          <div class="section-header">
            <span class="step-pill">2</span>
            <h2 class="section-title">Estado Actual</h2>
          </div>
          <div class="current-status-box" id="current-status-display">
            <!-- Actualizado din√°micamente -->
          </div>

          <form id="form-current-print">
            <div class="form-group">
              <label>
                <input type="checkbox" id="is-active">
                Hay una impresi√≥n en curso
              </label>
            </div>

            <div id="print-details" class="hidden">
              <div class="form-row">
                <div class="form-group">
                  <label for="item-type">Tipo de √≠tem</label>
                  <select id="item-type">
                    <option value="">Seleccionar...</option>
                    <option value="pocillos">Pocillos</option>
                    <option value="charolas">Charolas</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="batch-size">Tama√±o del lote</label>
                  <input type="number" id="batch-size" min="1" placeholder="4">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="start-time">Fecha y hora de inicio</label>
                  <input type="datetime-local" id="start-time">
                </div>

                <div class="form-group">
                  <label for="estimated-duration">Duraci√≥n estimada (minutos)</label>
                  <input type="number" id="estimated-duration" min="1" placeholder="180">
                </div>
              </div>
            </div>

            <button type="submit" class="btn-primary">Actualizar Estado Actual</button>
          </form>
        </section>
      </div>

      <div class="editor-column">
        <!-- Visualizador de Impresiones -->
        <section class="card">
          <div class="section-header">
            <span class="step-pill">3</span>
            <h2 class="section-title">Impresiones Registradas</h2>
          </div>
          <p class="text-muted" style="margin-bottom: var(--spacing-lg);">
            Califica cada impresi√≥n y registra cu√°ntas piezas salieron bien.
          </p>
          <div class="history-toolbar">
            <button type="button" class="btn-secondary" onclick="addHistoryItem()">+ Agregar impresi√≥n</button>
            <div class="legend">
              <span class="legend-item"><span class="legend-dot status-completed"></span>Exitosa</span>
              <span class="legend-item"><span class="legend-dot status-partial"></span>Parcial</span>
              <span class="legend-item"><span class="legend-dot status-failed"></span>Fallida</span>
              <span class="legend-item"><span class="legend-dot status-pending"></span>Pendiente</span>
            </div>
          </div>

          <div id="history-management">
            <!-- Renderizado din√°micamente -->
          </div>

          <div id="rating-panel" class="rating-panel hidden">
            <div class="rating-header">
              <div>
                <h3>Calificar impresi√≥n <span id="rating-id"></span></h3>
                <div class="helper-text" id="rating-meta"></div>
              </div>
              <button type="button" class="btn-secondary" onclick="closeRatingPanel()">Cerrar</button>
            </div>

            <form id="form-rate">
              <div class="panel-section">
                <div class="panel-title">Datos de impresi√≥n</div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="rate-date">Fecha</label>
                    <input type="date" id="rate-date" required>
                  </div>
                  <div class="form-group">
                    <label for="rate-item">Tipo de √≠tem</label>
                    <select id="rate-item" required>
                      <option value="pocillos">Pocillos</option>
                      <option value="charolas">Charolas</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="rate-batch">Tama√±o del lote</label>
                    <input type="number" id="rate-batch" min="1" required>
                  </div>
                  <div class="form-group">
                    <label for="rate-duration">Duraci√≥n (minutos)</label>
                    <input type="number" id="rate-duration" min="0">
                  </div>
                </div>
              </div>

              <div class="panel-section">
                <div class="panel-title">Calificaci√≥n</div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="rate-status">Resultado</label>
                    <select id="rate-status" required>
                      <option value="pending">‚è≥ Pendiente</option>
                      <option value="completed">‚úì Exitosa</option>
                      <option value="partial">‚ö†Ô∏è Parcial</option>
                      <option value="failed">‚úó Fallida</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="rate-good">Piezas buenas</label>
                    <input type="number" id="rate-good" min="0">
                    <div class="helper-text" id="rate-good-hint">Rango: 0 - 0</div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="rate-notes">Notas</label>
                  <textarea id="rate-notes" placeholder="Detalles del resultado"></textarea>
                </div>
              </div>

              <div class="rating-actions">
                <button type="submit" class="btn-primary">Guardar calificaci√≥n</button>
              </div>
            </form>
          </div>
        </section>

        <!-- Guardar y Publicar -->
        <section class="card save-panel">
          <div class="section-header">
            <span class="step-pill">4</span>
            <h2 class="section-title">Guardar y Publicar</h2>
          </div>
          <p>Guarda los cambios y actualiza el dashboard en GitHub Pages.</p>
          <button onclick="saveAndPush()" id="btn-save" class="btn-primary">
            üíæ Guardar y Subir a GitHub
          </button>
          <div id="save-status" class="save-status"></div>
        </section>
      </div>
    </div>
  </div>

  <script src="js/dataLoader.js"></script>
  <script>
    let currentData = null;

    // Cargar datos al iniciar
    async function loadData() {
      try {
        currentData = await DataLoader.load('data/print-data.json');
      } catch (error) {
        console.error('Error cargando datos:', error);
        alert('Error al cargar datos. Usando datos vac√≠os.');
        currentData = {
          meta: {
            projectName: "Proyecto Pensi√≥n Vald√©s",
            goals: { pocillos: 100, charolas: 20 },
            startDate: new Date().toISOString().split('T')[0],
            targetEndDate: "",
            workHoursPerDay: 18
          },
          currentPrint: {
            isActive: false,
            item: "",
            batchSize: 0,
            startTime: "",
            estimatedDuration: 0
          },
          history: [],
          issues: []
        };
      }

      updateCurrentStatusDisplay();
      loadProjectConfig();
      loadCurrentPrintForm();
    }

    // Actualizar display del estado actual
    function updateCurrentStatusDisplay() {
      const display = document.getElementById('current-status-display');
      const isActive = currentData.currentPrint.isActive;

      if (isActive) {
        display.innerHTML = `
          <span class="status-indicator status-active"></span>
          <strong>FUNCIONANDO</strong> - Imprimiendo ${currentData.currentPrint.batchSize}
          ${currentData.currentPrint.item} (estimado: ${currentData.currentPrint.estimatedDuration} min)
        `;
      } else {
        display.innerHTML = `
          <span class="status-indicator status-inactive"></span>
          <strong>EN REPOSO</strong> - No hay impresi√≥n activa
        `;
      }
    }

    // Cargar estado actual en el formulario
    function loadCurrentPrintForm() {
      const isActive = currentData.currentPrint.isActive;
      const isActiveInput = document.getElementById('is-active');
      const details = document.getElementById('print-details');

      isActiveInput.checked = isActive;
      details.classList.toggle('hidden', !isActive);

      if (isActive) {
        document.getElementById('item-type').value = currentData.currentPrint.item || '';
        document.getElementById('batch-size').value = currentData.currentPrint.batchSize || '';
        document.getElementById('start-time').value = currentData.currentPrint.startTime || '';
        document.getElementById('estimated-duration').value = currentData.currentPrint.estimatedDuration || '';
      } else {
        document.getElementById('item-type').value = '';
        document.getElementById('batch-size').value = '';
        document.getElementById('estimated-duration').value = '';

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('start-time').value = now.toISOString().slice(0, 16);
      }
    }

    // Cargar configuraci√≥n del proyecto en el formulario
    function loadProjectConfig() {
      document.getElementById('project-name').value = currentData.meta.projectName || '';
      document.getElementById('start-date-project').value = currentData.meta.startDate || '';
      document.getElementById('target-end-date').value = currentData.meta.targetEndDate || '';
      document.getElementById('goal-pocillos').value = currentData.meta.goals.pocillos || 100;
      document.getElementById('goal-charolas').value = currentData.meta.goals.charolas || 20;
      const workHours = currentData.meta.workHoursPerDay || 18;
      currentData.meta.workHoursPerDay = workHours;
      document.getElementById('work-hours').value = workHours;
    }

    // Form: Actualizar configuraci√≥n del proyecto
    document.getElementById('form-project-config').addEventListener('submit', (e) => {
      e.preventDefault();

      currentData.meta.projectName = document.getElementById('project-name').value;
      currentData.meta.startDate = document.getElementById('start-date-project').value;
      currentData.meta.targetEndDate = document.getElementById('target-end-date').value;
      currentData.meta.goals.pocillos = parseInt(document.getElementById('goal-pocillos').value);
      currentData.meta.goals.charolas = parseInt(document.getElementById('goal-charolas').value);
      currentData.meta.workHoursPerDay = parseInt(document.getElementById('work-hours').value);

      alert('Configuraci√≥n actualizada. Click en "Guardar y Subir a GitHub" para publicar.');
    });

    // Toggle detalles de impresi√≥n
    document.getElementById('is-active').addEventListener('change', (e) => {
      const details = document.getElementById('print-details');
      details.classList.toggle('hidden', !e.target.checked);
    });

    // Form: Actualizar estado actual
    document.getElementById('form-current-print').addEventListener('submit', (e) => {
      e.preventDefault();

      const previousPrint = { ...currentData.currentPrint };
      const isActive = document.getElementById('is-active').checked;

      if (isActive) {
        const itemType = document.getElementById('item-type').value;
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const startTime = document.getElementById('start-time').value;
        const estimatedDuration = parseInt(document.getElementById('estimated-duration').value);

        if (!itemType || !batchSize || !startTime || !estimatedDuration) {
          alert('Por favor completa todos los campos');
          return;
        }

        currentData.currentPrint = {
          isActive: true,
          item: itemType,
          batchSize: batchSize,
          startTime: startTime,
          estimatedDuration: estimatedDuration
        };
      } else {
        currentData.currentPrint = {
          isActive: false,
          item: "",
          batchSize: 0,
          startTime: "",
          estimatedDuration: 0
        };
      }

      updateCurrentStatusDisplay();
      if (currentData.currentPrint.isActive) {
        syncCurrentPrintToHistory(previousPrint);
      }
      renderHistoryTable();
      alert('Estado actual actualizado. Click en "Guardar y Subir a GitHub" para publicar.');
    });

    // Agregar impresi√≥n al historial
    function addHistoryItem() {
      if (!currentData) return;

      const newId = currentData.history.length > 0
        ? Math.max(...currentData.history.map(h => h.id)) + 1
        : 1;

      const today = new Date().toISOString().split('T')[0];
      const defaultItem = currentData.currentPrint.item || 'pocillos';
      const defaultBatch = currentData.currentPrint.batchSize || 1;
      const defaultDuration = currentData.currentPrint.estimatedDuration || 0;

      const newEntry = {
        id: newId,
        date: today,
        item: defaultItem,
        batchSize: defaultBatch,
        duration: defaultDuration,
        status: "pending",
        goodCount: 0,
        notes: ""
      };

      currentData.history.push(newEntry);
      renderHistoryTable();
      openRatingPanel(newId);
    }

    function syncCurrentPrintToHistory(previousPrint) {
      const currentPrint = currentData.currentPrint;
      if (!currentPrint.isActive) return;

      const currentStartTime = currentPrint.startTime;
      const existingIndex = currentData.history.findIndex(
        (h) => h.startTime && h.startTime === currentStartTime
      );

      if (existingIndex !== -1) {
        const existing = currentData.history[existingIndex];
        if (existing.status !== 'pending') return;

        currentData.history[existingIndex] = {
          ...existing,
          date: currentStartTime.split('T')[0],
          item: currentPrint.item,
          batchSize: currentPrint.batchSize,
          duration: existing.duration || 0,
          status: 'pending',
          startTime: currentStartTime,
          source: existing.source || 'currentPrint'
        };
        return;
      }

      const previousStartTime = previousPrint && previousPrint.startTime;
      if (previousStartTime && previousStartTime !== currentStartTime) {
        const previousIndex = currentData.history.findIndex(
          (h) => h.startTime && h.startTime === previousStartTime && h.status === 'pending'
        );
        if (previousIndex !== -1) {
          const existing = currentData.history[previousIndex];
          currentData.history[previousIndex] = {
            ...existing,
            date: currentStartTime.split('T')[0],
            item: currentPrint.item,
            batchSize: currentPrint.batchSize,
            duration: existing.duration || 0,
            status: 'pending',
            startTime: currentStartTime,
            source: existing.source || 'currentPrint'
          };
          return;
        }
      }

      const newId = currentData.history.length > 0
        ? Math.max(...currentData.history.map(h => h.id)) + 1
        : 1;

      currentData.history.push({
        id: newId,
        date: currentStartTime.split('T')[0],
        item: currentPrint.item,
        batchSize: currentPrint.batchSize,
        duration: 0,
        status: 'pending',
        goodCount: 0,
        notes: '',
        startTime: currentStartTime,
        source: 'currentPrint'
      });
    }

    // Guardar y hacer push a GitHub
    async function saveAndPush() {
      const btn = document.getElementById('btn-save');
      const status = document.getElementById('save-status');

      btn.disabled = true;
      btn.textContent = '‚è≥ Guardando...';
      status.textContent = '';

      try {
        // 1. Guardar archivo
        const saveResponse = await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentData)
        });

        const saveData = await saveResponse.json();

        if (!saveData.success) {
          throw new Error(saveData.error || 'Error al guardar');
        }

        status.innerHTML = '‚úÖ Archivo guardado<br>';
        btn.textContent = 'üì§ Subiendo a GitHub...';

        // 2. Git push
        const pushResponse = await fetch('/api/git-push', {
          method: 'POST'
        });

        const pushData = await pushResponse.json();

        if (!pushData.success) {
          throw new Error(pushData.error || 'Error en git push');
        }

        status.innerHTML += '‚úÖ Cambios subidos a GitHub<br><br>üéâ ¬°Dashboard actualizado! Visita:<br><a href="https://ortegamatias.github.io/PensionValdes/" target="_blank">https://ortegamatias.github.io/PensionValdes/</a>';
        btn.textContent = '‚úÖ Completado';

        setTimeout(() => {
          btn.textContent = 'üíæ Guardar y Subir a GitHub';
          btn.disabled = false;
        }, 3000);

      } catch (error) {
        console.error('Error:', error);
        status.innerHTML = `‚ùå Error: ${error.message}`;
        btn.textContent = '‚ùå Error - Reintentar';
        btn.disabled = false;
      }
    }

    // Renderizar tabla de historial
    function renderHistoryTable() {
      const container = document.getElementById('history-management');
      if (!container) return;

      if (!currentData.history || currentData.history.length === 0) {
        container.innerHTML = '<div class="no-history">No hay impresiones en el historial</div>';
        return;
      }

      // Ordenar por ID (m√°s reciente primero)
      const sorted = [...currentData.history].sort((a, b) => b.id - a.id);

      const rows = sorted.map(h => {
        const statusLabels = {
          'pending': '<span class="status-pending">‚è≥ Pendiente</span>',
          'completed': '<span class="status-completed">‚úì Exitosa</span>',
          'partial': '<span class="status-partial">‚ö†Ô∏è Parcial</span>',
          'failed': '<span class="status-failed">‚úó Fallida</span>'
        };
        const statusBadge = statusLabels[h.status] || '<span class="status-pending">‚è≥ Pendiente</span>';
        const hasGoodCount = Number.isFinite(h.goodCount);
        const goodCountDisplay = hasGoodCount
          ? h.goodCount
          : (h.status === 'completed' ? h.batchSize : (h.status === 'failed' ? 0 : '--'));
        const durationDisplay = h.duration > 0 ? `${h.duration} min` : '--';

        return `
          <tr id="row-${h.id}" class="${h.status === 'pending' ? 'row-pending' : ''}">
            <td>#${h.id}</td>
            <td>${h.date}</td>
            <td>${h.item === 'pocillos' ? 'Pocillos' : 'Charolas'}</td>
            <td>${h.batchSize}</td>
            <td>${goodCountDisplay}</td>
            <td>${durationDisplay}</td>
            <td>${statusBadge}</td>
            <td>${h.notes || '--'}</td>
            <td>
              <button class="btn-small btn-edit" onclick="openRatingPanel(${h.id})">‚úÖ Calificar</button>
              <button class="btn-small btn-delete" onclick="deleteHistoryItem(${h.id})">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <div class="table-scroll">
          <table class="history-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>√çtem</th>
                <th>Lote</th>
                <th>Buenas</th>
                <th>Duraci√≥n</th>
                <th>Estado</th>
                <th>Notas</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      `;
    }

    // Panel de calificaci√≥n
    let editingId = null;

    function openRatingPanel(id) {
      const item = currentData.history.find(h => h.id === id);
      if (!item) return;

      editingId = id;

      const itemLabel = item.item === 'charolas' ? 'Charolas' : 'Pocillos';
      document.getElementById('rating-id').textContent = `#${id}`;
      document.getElementById('rating-meta').textContent = `${itemLabel} ¬∑ Lote ${item.batchSize}`;

      document.getElementById('rate-date').value = item.date || new Date().toISOString().split('T')[0];
      document.getElementById('rate-item').value = item.item || 'pocillos';
      document.getElementById('rate-batch').value = item.batchSize || 1;
      document.getElementById('rate-duration').value = item.duration || 0;
      document.getElementById('rate-status').value = item.status || 'pending';

      const goodCountDefault = Number.isFinite(item.goodCount)
        ? item.goodCount
        : (item.status === 'completed' ? item.batchSize : 0);
      document.getElementById('rate-good').value = goodCountDefault;
      document.getElementById('rate-notes').value = item.notes || '';

      updateGoodHint();
      document.getElementById('rating-panel').classList.remove('hidden');
    }

    function closeRatingPanel() {
      editingId = null;
      document.getElementById('rating-panel').classList.add('hidden');
    }

    function updateGoodHint() {
      const batchValue = parseInt(document.getElementById('rate-batch').value);
      const batchSize = Number.isNaN(batchValue) ? 0 : batchValue;
      const hint = document.getElementById('rate-good-hint');
      hint.textContent = `Rango: 0 - ${batchSize}`;

      const goodValue = parseInt(document.getElementById('rate-good').value);
      if (!Number.isNaN(goodValue) && goodValue > batchSize) {
        document.getElementById('rate-good').value = batchSize;
      }
    }

    document.getElementById('rate-batch').addEventListener('input', updateGoodHint);
    document.getElementById('rate-status').addEventListener('change', () => {
      const status = document.getElementById('rate-status').value;
      const batchValue = parseInt(document.getElementById('rate-batch').value);
      const batchSize = Number.isNaN(batchValue) ? 0 : batchValue;
      const goodInput = document.getElementById('rate-good');

      if (status === 'completed') {
        goodInput.value = batchSize;
      } else if (status === 'failed') {
        goodInput.value = 0;
      }
    });

    document.getElementById('form-rate').addEventListener('submit', (e) => {
      e.preventDefault();
      if (editingId === null) return;

      const itemIndex = currentData.history.findIndex(h => h.id === editingId);
      if (itemIndex === -1) return;

      const batchValue = parseInt(document.getElementById('rate-batch').value);
      const durationValue = parseInt(document.getElementById('rate-duration').value);
      const batchSize = Number.isNaN(batchValue) ? 0 : batchValue;
      const duration = Number.isNaN(durationValue) ? 0 : durationValue;
      const status = document.getElementById('rate-status').value;
      let goodCount = parseInt(document.getElementById('rate-good').value);

      if (Number.isNaN(goodCount)) {
        goodCount = status === 'completed' ? batchSize : 0;
      }

      if (status === 'completed') {
        goodCount = batchSize;
      } else if (status === 'failed') {
        goodCount = 0;
      } else {
        goodCount = Math.min(Math.max(0, goodCount), batchSize);
      }

      const existing = currentData.history[itemIndex];
      currentData.history[itemIndex] = {
        ...existing,
        id: editingId,
        date: document.getElementById('rate-date').value,
        item: document.getElementById('rate-item').value,
        batchSize: batchSize,
        goodCount: goodCount,
        duration: duration,
        status: status,
        notes: document.getElementById('rate-notes').value
      };

      renderHistoryTable();
      openRatingPanel(editingId);
      alert('Calificaci√≥n guardada. No olvides hacer click en "Guardar y Subir a GitHub".');
    });

    // Eliminar entrada del historial
    function deleteHistoryItem(id) {
      if (!confirm(`¬øSeguro que quieres eliminar la impresi√≥n #${id}?`)) {
        return;
      }

      currentData.history = currentData.history.filter(h => h.id !== id);

      // Tambi√©n eliminar issues relacionados
      currentData.issues = currentData.issues.filter(i => i.printId !== id);

      if (editingId === id) {
        closeRatingPanel();
      }

      renderHistoryTable();
      alert('Entrada eliminada. No olvides hacer click en "Guardar y Subir a GitHub".');
    }

    // Inicializar
    async function init() {
      await loadData();
      if (currentData && currentData.currentPrint && currentData.currentPrint.isActive) {
        syncCurrentPrintToHistory();
      }
      renderHistoryTable();
    }

    init();

  </script>
</body>
</html>
